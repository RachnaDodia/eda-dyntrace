---
- name: Watching for Problems on Dynatrace
  hosts: all
  sources:
    - dynatrace.event_driven_ansible.dt_esa_api:
        dt_api_host: "{{ dynatrace_host }}"
        dt_api_token: "{{ dynatrace_token }}"
        delay: "{{ dynatrace_delay }}"

  rules:
    - name: Look for open Synthetic monitor problem
      #condition: event.title == "Process unavailable"
      condition: event.title == "No process found for rule Nginx Host monitor"
      action:
        run_job_template:
          name: Fix Nginx and update all
          organization: "Default"
          job_args:
            limit: "{{ event.impactedEntities[0].name }}"
            extra_vars:
              problemID: "{{ event.displayId }}"
              #reporting_host: "{{ event.impactedEntities.name }}"
